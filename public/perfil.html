<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Perfil - Odontologia Vigia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        .profile-form {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.85);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-400 to-blue-500 flex items-center justify-center min-h-screen">

    <div class="profile-form p-8 rounded-2xl shadow-2xl w-full max-w-2xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Meu Perfil</h2>
        <p class="text-sm text-gray-600 mb-4 text-center">
            Visualize e atualize suas informações de perfil.
        </p>

        <form id="profileForm" class="space-y-4">
            <div>
                <label for="nome" class="block text-gray-700 text-sm font-semibold">Nome Completo</label>
                <input
                    type="text"
                    id="nome"
                    name="nome"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-semibold">E-mail</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    readonly
                    class="w-full px-4 py-2 mt-1 border rounded-lg bg-gray-100 cursor-not-allowed"
                />
            </div>
            <div>
                <label for="cpf" class="block text-gray-700 text-sm font-semibold">CPF</label>
                <input
                    type="text"
                    id="cpf"
                    name="cpf"
                    placeholder="000.000.000-00"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="telefone" class="block text-gray-700 text-sm font-semibold">Telefone</label>
                <input
                    type="tel"
                    id="telefone"
                    name="telefone"
                    placeholder="(XX) XXXXX-XXXX"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="data_nascimento" class="block text-gray-700 text-sm font-semibold">Data de Nascimento</label>
                <input
                    type="date"
                    id="data_nascimento"
                    name="data_nascimento"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="sexo" class="block text-gray-700 text-sm font-semibold">Sexo</label>
                <select
                    id="sexo"
                    name="sexo"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                >
                    <option value="">Selecione</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            <div>
                <label for="endereco" class="block text-gray-700 text-sm font-semibold">Endereço Completo</label>
                <textarea
                    id="endereco"
                    name="endereco"
                    rows="3"
                    placeholder="Rua, Número, Bairro, Cidade, Estado, CEP"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                ></textarea>
            </div>
            <div>
                <label for="plano" class="block text-gray-700 text-sm font-semibold">Plano Odontológico (Opcional)</label>
                <input
                    type="text"
                    id="plano"
                    name="plano"
                    placeholder="Nome do seu plano"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="quick_notes" class="block text-gray-700 text-sm font-semibold">Anotações Rápidas (Prontuário - Opcional)</label>
                <textarea
                    id="quick_notes"
                    name="quick_notes"
                    rows="3"
                    placeholder="Informações relevantes para seu prontuário (ex: histórico médico, alergias adicionais)"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                ></textarea>
            </div>

            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition"
            >
                Salvar Alterações
            </button>
        </form>

        <p id="mensagem" class="mt-4 text-center font-semibold hidden"></p>

        <div class="mt-6 text-center">
            <a href="area_paciente.html" class="text-blue-600 hover:underline text-sm">
                Voltar para a Área do Paciente
            </a>
        </div>
    </div>

    <script type="module">
        // Importe as funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        // getFirestore não é estritamente necessário aqui se a API Flask faz todas as operações
        // import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // ATENÇÃO: Substitua os valores abaixo pela sua nova firebaseConfig
        // que você obteve do console do Firebase após recriar o app web.
        const firebaseConfig = {
            apiKey: "SUA_NOVA_API_KEY_AQUI",
            authDomain: "SEU_AUTH_DOMAIN_AQUI",
            projectId: "SEU_PROJECT_ID_AQUI",
            storageBucket: "SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
            appId: "SEU_NOVO_APP_ID_AQUI"
        };

        // Inicialize o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Instância de autenticação

        // URL da sua API Flask. Para deploy no Vercel, DEVE ser "/api".
        const flaskApiUrl = "/api";

        // Elementos do DOM
        const profileForm = document.getElementById("profileForm");
        const mensagemEl = document.getElementById("mensagem");
        const nomeEl = document.getElementById("nome");
        const emailEl = document.getElementById("email");
        const cpfEl = document.getElementById("cpf");
        const telefoneEl = document.getElementById("telefone");
        const dataNascimentoEl = document.getElementById("data_nascimento");
        const sexoEl = document.getElementById("sexo");
        const enderecoEl = document.getElementById("endereco");
        const planoEl = document.getElementById("plano");
        const quickNotesEl = document.getElementById("quick_notes");

        let currentUserEmail = null; // Para armazenar o email do usuário logado

        // Função para exibir mensagens de erro/sucesso
        function showMessage(text, isError = true) {
            mensagemEl.textContent = text;
            mensagemEl.classList.remove("hidden");
            if (isError) {
                mensagemEl.classList.remove("text-green-600");
                mensagemEl.classList.add("text-red-600");
            } else {
                mensagemEl.classList.remove("text-red-600");
                mensagemEl.classList.add("text-green-600");
            }
        }

        // Carrega os dados do perfil ao carregar a página
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                emailEl.value = user.email; // Preenche o email (somente leitura)
                
                // Tenta carregar os dados do perfil da API Flask
                try {
                    const res = await fetch(`${flaskApiUrl}/completar_perfil`, {
                        method: "POST", // Usamos POST para enviar o email
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email: currentUserEmail })
                    });
                    const data = await res.json();

                    if (res.ok && data.usuario) {
                        nomeEl.value = data.usuario.nome || '';
                        cpfEl.value = data.usuario.cpf || '';
                        telefoneEl.value = data.usuario.telefone || '';
                        dataNascimentoEl.value = data.usuario.data_nascimento || '';
                        sexoEl.value = data.usuario.sexo || '';
                        enderecoEl.value = data.usuario.endereco || '';
                        planoEl.value = data.usuario.plano || '';
                        quickNotesEl.value = data.usuario.quick_notes || '';
                    } else {
                        console.error("Erro ao carregar dados do perfil:", data.erro);
                        showMessage("Não foi possível carregar os dados do perfil.", true);
                    }
                } catch (err) {
                    console.error("Erro de rede ao carregar perfil:", err);
                    showMessage("Erro de conexão ao carregar perfil. Tente novamente.", true);
                }
            } else {
                // Se não logado via Firebase Auth, tenta carregar do localStorage (Email/Senha)
                const storedUser = localStorage.getItem('usuario');
                if (storedUser) {
                    const parsedUser = JSON.parse(storedUser);
                    currentUserEmail = parsedUser.email;
                    emailEl.value = parsedUser.email;
                    nomeEl.value = parsedUser.nome || ''; // Preenche o nome se disponível
                    // Tenta carregar o restante do perfil via API
                    try {
                        const res = await fetch(`${flaskApiUrl}/completar_perfil`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ email: currentUserEmail })
                        });
                        const data = await res.json();
                        if (res.ok && data.usuario) {
                            cpfEl.value = data.usuario.cpf || '';
                            telefoneEl.value = data.usuario.telefone || '';
                            dataNascimentoEl.value = data.usuario.data_nascimento || '';
                            sexoEl.value = data.usuario.sexo || '';
                            enderecoEl.value = data.usuario.endereco || '';
                            planoEl.value = data.usuario.plano || '';
                            quickNotesEl.value = data.usuario.quick_notes || '';
                        }
                    } catch (err) {
                        console.error("Erro de rede ao carregar perfil via localStorage:", err);
                    }
                } else {
                    // Nenhum usuário logado, redireciona para a página de login
                    window.location.href = "login.html";
                }
            }
        });

        // Lida com o envio do formulário de perfil
        profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!currentUserEmail) {
                showMessage("Erro: E-mail do usuário não identificado. Por favor, faça login novamente.", true);
                return;
            }

            const formData = new FormData(profileForm);
            const profileData = {
                email: currentUserEmail, // Garante que o email do usuário logado seja usado
                nome: formData.get("nome"),
                cpf: formData.get("cpf"),
                telefone: formData.get("telefone"),
                data_nascimento: formData.get("data_nascimento"),
                sexo: formData.get("sexo"),
                endereco: formData.get("endereco"),
                plano: formData.get("plano"),
                quick_notes: formData.get("quick_notes")
            };

            try {
                const res = await fetch(`${flaskApiUrl}/completar_perfil`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(profileData)
                });

                const data = await res.json();
                if (res.ok) {
                    showMessage(data.mensagem, false);
                    // Atualiza o localStorage com o nome atualizado, se aplicável
                    const storedUser = JSON.parse(localStorage.getItem('usuario'));
                    if (storedUser) {
                        storedUser.nome = profileData.nome;
                        localStorage.setItem('usuario', JSON.stringify(storedUser));
                    }
                } else {
                    showMessage(data.erro);
                }
            } catch (err) {
                console.error("Erro ao atualizar perfil:", err);
                showMessage("Erro ao conectar com o servidor. Tente novamente mais tarde.");
            }
        });
    </script>
</body>
</html>
