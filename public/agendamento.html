<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendar Consulta - Odontologia Vigia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        .agendamento-form {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.85);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-400 to-blue-500 flex items-center justify-center min-h-screen">

    <div class="agendamento-form p-8 rounded-2xl shadow-2xl w-full max-w-xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Agendar Nova Consulta</h2>
        <p class="text-sm text-gray-600 mb-4 text-center">
            Preencha os dados abaixo para solicitar seu agendamento.
        </p>

        <form id="agendamentoForm" class="space-y-4">
            <div>
                <label for="pacienteNome" class="block text-gray-700 text-sm font-semibold">Nome do Paciente</label>
                <input
                    type="text"
                    id="pacienteNome"
                    name="pacienteNome"
                    required
                    placeholder="Seu nome completo"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-semibold">E-mail do Paciente</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    placeholder="seuemail@exemplo.com"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="data_consulta" class="block text-gray-700 text-sm font-semibold">Data da Consulta</label>
                <input
                    type="date"
                    id="data_consulta"
                    name="data_consulta"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="hora_consulta" class="block text-gray-700 text-sm font-semibold">Hora da Consulta</label>
                <input
                    type="time"
                    id="hora_consulta"
                    name="hora_consulta"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>
            <div>
                <label for="dentista" class="block text-gray-700 text-sm font-semibold">Dentista Preferencial</label>
                <select
                    id="dentista"
                    name="dentista"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                >
                    <option value="">Selecione um dentista</option>
                    <option value="Dra. Carla Mendes">Dra. Carla Mendes</option>
                    <option value="Dr. Roberto Almeida">Dr. Roberto Almeida</option>
                    <option value="Dra. Fernanda Lara">Dra. Fernanda Lara</option>
                </select>
            </div>
            <div>
                <label for="procedimento" class="block text-gray-700 text-sm font-semibold">Procedimento Desejado</label>
                <select
                    id="procedimento"
                    name="procedimento"
                    required
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                >
                    <option value="">Selecione um procedimento</option>
                    <option value="Clareamento Dental">Clareamento Dental</option>
                    <option value="Implantes Dentários">Implantes Dentários</option>
                    <option value="Ortodontia">Ortodontia</option>
                    <option value="Estética Dental">Estética Dental</option>
                    <option value="Endodontia">Endodontia</option>
                    <option value="Odontopediatria">Odontopediatria</option>
                    <option value="Consulta de Rotina">Consulta de Rotina</option>
                </select>
            </div>
            <div>
                <label for="relato_cliente" class="block text-gray-700 text-sm font-semibold">Relato/Observações (Opcional)</label>
                <textarea
                    id="relato_cliente"
                    name="relato_cliente"
                    rows="3"
                    placeholder="Descreva brevemente o motivo da consulta ou outras observações..."
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                ></textarea>
            </div>

            <div class="space-y-2">
                <p class="block text-gray-700 text-sm font-semibold">Problemas de Saúde (Opcional):</p>
                <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="diabetes" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Diabetes</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="hipertensao" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Hipertensão</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="cardio" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Cardiopatia</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="alergias" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Alergias</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="coagulacao" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Problemas de Coagulação</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="saude" value="none" class="form-checkbox text-blue-600">
                        <span class="ml-2 text-gray-700">Nenhum</span>
                    </label>
                </div>
            </div>

            <div>
                <label for="medication" class="block text-gray-700 text-sm font-semibold">Medicação em uso (Opcional)</label>
                <input
                    type="text"
                    id="medication"
                    name="medication"
                    placeholder="Ex: AAS, Losartana"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>

            <div>
                <label for="dentes_afetados" class="block text-gray-700 text-sm font-semibold">Dentes afetados (Opcional, ex: 14, 25)</label>
                <input
                    type="text"
                    id="dentes_afetados"
                    name="dentes_afetados"
                    placeholder="Números dos dentes separados por vírgula (ex: 14, 25)"
                    class="w-full px-4 py-2 mt-1 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                />
            </div>

            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition"
            >
                Agendar Consulta
            </button>
        </form>

        <p id="mensagem" class="mt-4 text-center font-semibold hidden"></p>

        <div class="mt-6 text-center">
            <a href="area_paciente.html" class="text-blue-600 hover:underline text-sm">
                Voltar para a Área do Paciente
            </a>
        </div>
    </div>

    <script type="module">
        // Importe as funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        // Para agendamento, talvez você precise de getAuth para obter o email do usuário logado
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

        // SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // ATENÇÃO: Substitua os valores abaixo pela sua nova firebaseConfig
        // que você obteve do console do Firebase após recriar o app web.
        const firebaseConfig = {
            apiKey: "SUA_NOVA_API_KEY_AQUI",
            authDomain: "SEU_AUTH_DOMAIN_AQUI",
            projectId: "SEU_PROJECT_ID_AQUI",
            storageBucket: "SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
            appId: "SEU_NOVO_APP_ID_AQUI"
        };

        // Inicialize o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Instância de autenticação

        // URL da sua API Flask. Para deploy no Vercel, DEVE ser "/api".
        const flaskApiUrl = "/api";

        // Elementos do DOM
        const agendamentoForm = document.getElementById("agendamentoForm");
        const mensagemEl = document.getElementById("mensagem");
        const pacienteNomeEl = document.getElementById("pacienteNome");
        const emailEl = document.getElementById("email");

        let currentUserEmail = null; // Para armazenar o email do usuário logado

        // Função para exibir mensagens de erro/sucesso
        function showMessage(text, isError = true) {
            mensagemEl.textContent = text;
            mensagemEl.classList.remove("hidden");
            if (isError) {
                mensagemEl.classList.remove("text-green-600");
                mensagemEl.classList.add("text-red-600");
            } else {
                mensagemEl.classList.remove("text-red-600");
                mensagemEl.classList.add("text-green-600");
            }
        }

        // Preenche o campo de e-mail e nome se o usuário estiver logado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                emailEl.value = user.email;
                emailEl.readOnly = true; // Torna o campo de e-mail somente leitura
                
                // Tenta carregar o nome do usuário do localStorage ou da API
                const storedUser = localStorage.getItem('usuario');
                if (storedUser) {
                    const parsedUser = JSON.parse(storedUser);
                    pacienteNomeEl.value = parsedUser.nome || '';
                } else {
                    // Se não estiver no localStorage, pode tentar buscar da API (opcional)
                    // fetch(`${flaskApiUrl}/completar_perfil`, { method: "POST", body: JSON.stringify({ email: user.email }) })
                    // .then(res => res.json()).then(data => { if(data.usuario) pacienteNomeEl.value = data.usuario.nome; });
                }
            } else {
                // Se não houver usuário logado via Firebase Auth, verifica localStorage para email/senha
                const storedUser = localStorage.getItem('usuario');
                if (storedUser) {
                    const parsedUser = JSON.parse(storedUser);
                    currentUserEmail = parsedUser.email;
                    emailEl.value = parsedUser.email;
                    emailEl.readOnly = true;
                    pacienteNomeEl.value = parsedUser.nome || '';
                } else {
                    // Nenhum usuário logado, redireciona para a página de login
                    window.location.href = "login.html";
                }
            }
        });


        // Lida com o envio do formulário de agendamento
        agendamentoForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!currentUserEmail) {
                showMessage("Erro: E-mail do paciente não identificado. Por favor, faça login novamente.", true);
                return;
            }

            const formData = new FormData(agendamentoForm);
            const agendamentoData = {
                email: currentUserEmail, // Garante que o email do usuário logado seja usado
                paciente: formData.get("pacienteNome"),
                data_consulta: formData.get("data_consulta"),
                hora_consulta: formData.get("hora_consulta"),
                dentista: formData.get("dentista"),
                procedimento: formData.get("procedimento"),
                relato_cliente: formData.get("relato_cliente"),
                medication: formData.get("medication"),
                dentes_afetados: formData.get("dentes_afetados") ? formData.get("dentes_afetados").split(',').map(s => s.trim()) : []
            };

            // Adiciona problemas de saúde selecionados
            const saudeCheckboxes = document.querySelectorAll('input[name="saude"]:checked');
            saudeCheckboxes.forEach(checkbox => {
                agendamentoData[checkbox.value] = true;
            });
            // Se "Nenhum" for selecionado e outros também, prioriza "Nenhum"
            if (agendamentoData.none) {
                agendamentoData.diabetes = false;
                agendamentoData.hipertensao = false;
                agendamentoData.cardio = false;
                agendamentoData.alergias = false;
                agendamentoData.coagulacao = false;
            }


            try {
                const res = await fetch(`${flaskApiUrl}/agendar_consulta`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(agendamentoData)
                });

                const data = await res.json();
                if (res.ok) {
                    showMessage(data.mensagem, false);
                    agendamentoForm.reset(); // Limpa o formulário após o sucesso
                    // Opcional: Redirecionar para a área do paciente
                    setTimeout(() => {
                        window.location.href = "area_paciente.html";
                    }, 2000);
                } else {
                    showMessage(data.erro);
                }
            } catch (err) {
                console.error("Erro ao agendar consulta:", err);
                showMessage("Erro ao conectar com o servidor. Tente novamente mais tarde.");
            }
        });
    </script>
</body>
</html>
