<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Prontuário - Odontologia Vigia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        .prontuario-card {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.85);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-400 to-blue-500 flex items-center justify-center min-h-screen">

    <div class="prontuario-card p-8 rounded-2xl shadow-2xl w-full max-w-3xl">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Meu Prontuário</h2>
        <p class="text-sm text-gray-600 mb-4 text-center">
            Informações importantes sobre sua saúde bucal e geral.
        </p>

        <div class="space-y-6">
            <!-- Informações Básicas do Paciente -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Dados do Paciente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <div>
                        <p><strong class="font-medium">Nome:</strong> <span id="prontuarioNome">Carregando...</span></p>
                        <p><strong class="font-medium">E-mail:</strong> <span id="prontuarioEmail">Carregando...</span></p>
                        <p><strong class="font-medium">CPF:</strong> <span id="prontuarioCpf">Carregando...</span></p>
                    </div>
                    <div>
                        <p><strong class="font-medium">Telefone:</strong> <span id="prontuarioTelefone">Carregando...</span></p>
                        <p><strong class="font-medium">Nascimento:</strong> <span id="prontuarioDataNascimento">Carregando...</span></p>
                        <p><strong class="font-medium">Sexo:</strong> <span id="prontuarioSexo">Carregando...</span></p>
                    </div>
                    <div class="md:col-span-2">
                        <p><strong class="font-medium">Endereço:</strong> <span id="prontuarioEndereco">Carregando...</span></p>
                        <p><strong class="font-medium">Plano Odontológico:</strong> <span id="prontuarioPlano">Carregando...</span></p>
                    </div>
                </div>
            </div>

            <!-- Histórico Médico e Anotações Rápidas -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Histórico Médico e Anotações</h3>
                <div class="space-y-3 text-gray-700">
                    <p><strong class="font-medium">Problemas de Saúde:</strong> <span id="prontuarioSaude">Carregando...</span></p>
                    <p><strong class="font-medium">Medicação em Uso:</strong> <span id="prontuarioMedication">Carregando...</span></p>
                    <p><strong class="font-medium">Dentes Afetados:</strong> <span id="prontuarioDentesAfetados">Carregando...</span></p>
                    <p><strong class="font-medium">Anotações Rápidas (Quick Notes):</strong> <span id="prontuarioQuickNotes">Carregando...</span></p>
                </div>
            </div>

            <!-- Histórico de Agendamentos (simplificado, pode ser expandido) -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Histórico de Agendamentos</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-3 text-left text-gray-700 text-sm">Data</th>
                                <th class="py-2 px-3 text-left text-gray-700 text-sm">Hora</th>
                                <th class="py-2 px-3 text-left text-gray-700 text-sm">Procedimento</th>
                                <th class="py-2 px-3 text-left text-gray-700 text-sm">Dentista</th>
                                <th class="py-2 px-3 text-left text-gray-700 text-sm">Status</th>
                            </tr>
                        </thead>
                        <tbody id="prontuarioHistoricoAgendamentos">
                            <!-- Agendamentos serão carregados aqui -->
                            <tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">Nenhum histórico de agendamento.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <p id="mensagem" class="mt-4 text-center font-semibold hidden"></p>

        <div class="mt-6 text-center">
            <a href="area_paciente.html" class="text-blue-600 hover:underline text-sm">
                Voltar para a Área do Paciente
            </a>
        </div>
    </div>

    <script type="module">
        // Importe as funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        // getFirestore não é estritamente necessário aqui se a API Flask faz todas as operações
        // import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // ATENÇÃO: Substitua os valores abaixo pela sua nova firebaseConfig
        // que você obteve do console do Firebase após recriar o app web.
        const firebaseConfig = {
            apiKey: "SUA_NOVA_API_KEY_AQUI",
            authDomain: "SEU_AUTH_DOMAIN_AQUI",
            projectId: "SEU_PROJECT_ID_AQUI",
            storageBucket: "SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
            appId: "SEU_NOVO_APP_ID_AQUI"
        };

        // Inicialize o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Instância de autenticação

        // URL da sua API Flask. Para deploy no Vercel, DEVE ser "/api".
        const flaskApiUrl = "/api";

        // Elementos do DOM para preenchimento
        const prontuarioNomeEl = document.getElementById('prontuarioNome');
        const prontuarioEmailEl = document.getElementById('prontuarioEmail');
        const prontuarioCpfEl = document.getElementById('prontuarioCpf');
        const prontuarioTelefoneEl = document.getElementById('prontuarioTelefone');
        const prontuarioDataNascimentoEl = document.getElementById('prontuarioDataNascimento');
        const prontuarioSexoEl = document.getElementById('prontuarioSexo');
        const prontuarioEnderecoEl = document.getElementById('prontuarioEndereco');
        const prontuarioPlanoEl = document.getElementById('prontuarioPlano');
        const prontuarioSaudeEl = document.getElementById('prontuarioSaude');
        const prontuarioMedicationEl = document.getElementById('prontuarioMedication');
        const prontuarioDentesAfetadosEl = document.getElementById('prontuarioDentesAfetados');
        const prontuarioQuickNotesEl = document.getElementById('prontuarioQuickNotes');
        const prontuarioHistoricoAgendamentosBody = document.getElementById('prontuarioHistoricoAgendamentos');
        const mensagemEl = document.getElementById('mensagem');

        let currentUserEmail = null;

        // Função para exibir mensagens de erro/sucesso
        function showMessage(text, isError = true) {
            mensagemEl.textContent = text;
            mensagemEl.classList.remove("hidden");
            if (isError) {
                mensagemEl.classList.remove("text-green-600");
                mensagemEl.classList.add("text-red-600");
            } else {
                mensagemEl.classList.remove("text-red-600");
                mensagemEl.classList.add("text-green-600");
            }
        }

        // Função para carregar os dados do prontuário
        async function loadProntuarioData(userEmail) {
            try {
                // Carregar dados de perfil (que incluem quick_notes e histórico de saúde)
                const profileRes = await fetch(`${flaskApiUrl}/completar_perfil`, {
                    method: "POST", // Usamos POST para enviar o email
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: userEmail })
                });
                const profileData = await profileRes.json();

                if (profileRes.ok && profileData.usuario) {
                    const user = profileData.usuario;
                    prontuarioNomeEl.textContent = user.nome || 'N/A';
                    prontuarioEmailEl.textContent = user.email || 'N/A';
                    prontuarioCpfEl.textContent = user.cpf || 'N/A';
                    prontuarioTelefoneEl.textContent = user.telefone || 'N/A';
                    prontuarioDataNascimentoEl.textContent = user.data_nascimento || 'N/A';
                    prontuarioSexoEl.textContent = user.sexo || 'N/A';
                    prontuarioEnderecoEl.textContent = user.endereco || 'N/A';
                    prontuarioPlanoEl.textContent = user.plano || 'N/A';

                    // Problemas de saúde
                    const saudeIssues = [];
                    if (user.diabetes) saudeIssues.push('Diabetes');
                    if (user.hipertensao) saudeIssues.push('Hipertensão');
                    if (user.cardio) saudeIssues.push('Cardiopatia');
                    if (user.alergias) saudeIssues.push('Alergias');
                    if (user.coagulacao) saudeIssues.push('Problemas de Coagulação');
                    if (user.none) saudeIssues.push('Nenhum problema de saúde declarado');
                    prontuarioSaudeEl.textContent = saudeIssues.length > 0 ? saudeIssues.join(', ') : 'N/A';

                    prontuarioMedicationEl.textContent = user.medication || 'N/A';
                    prontuarioDentesAfetadosEl.textContent = Array.isArray(user.dentes_afetados) && user.dentes_afetados.length > 0 ? user.dentes_afetados.join(', ') : 'N/A';
                    prontuarioQuickNotesEl.textContent = user.quick_notes || 'N/A';
                } else {
                    console.error("Erro ao carregar dados do perfil para prontuário:", profileData.erro);
                    showMessage("Não foi possível carregar os dados do prontuário.", true);
                }

                // Carregar histórico de agendamentos
                const appointmentsRes = await fetch(`${flaskApiUrl}/agendamentos_paciente?email=${userEmail}`);
                const appointmentsData = await appointmentsRes.json();

                prontuarioHistoricoAgendamentosBody.innerHTML = ''; // Limpa a tabela

                if (appointmentsRes.ok && appointmentsData.agendamentos && appointmentsData.agendamentos.length > 0) {
                    appointmentsData.agendamentos.forEach(app => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-2 px-3">${app.data_consulta}</td>
                            <td class="py-2 px-3">${app.hora_consulta}</td>
                            <td class="py-2 px-3">${app.procedimento}</td>
                            <td class="py-2 px-3">${app.dentista}</td>
                            <td class="py-2 px-3 text-${app.status === 'Pago' ? 'green' : (app.status === 'Pendente' ? 'yellow' : 'gray')}-600 font-medium">${app.status}</td>
                        `;
                        prontuarioHistoricoAgendamentosBody.appendChild(row);
                    });
                } else {
                    prontuarioHistoricoAgendamentosBody.innerHTML = '<tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">Nenhum histórico de agendamento encontrado.</td></tr>';
                }

            } catch (error) {
                console.error("Erro geral ao carregar prontuário:", error);
                showMessage("Erro de conexão ao carregar prontuário. Tente novamente.", true);
                // Redirecionar para login se houver erro grave (ex: usuário não autenticado)
                // window.location.href = "login.html";
            }
        }

        // Verifica o estado de autenticação ao carregar a página
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                loadProntuarioData(currentUserEmail);
            } else {
                // Se não logado via Firebase Auth, tenta carregar do localStorage (Email/Senha)
                const storedUser = localStorage.getItem('usuario');
                if (storedUser) {
                    const parsedUser = JSON.parse(storedUser);
                    currentUserEmail = parsedUser.email;
                    loadProntuarioData(currentUserEmail);
                } else {
                    // Nenhum usuário logado, redireciona para a página de login
                    window.location.href = "login.html";
                }
            }
        });
    </script>
</body>
</html>
