<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Área do Paciente - Odontologia Vigia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        .dashboard-card {
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: scale(1.03);
        }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen flex flex-col">

    <!-- Header/Navigation (simplificado para a área do paciente) -->
    <header class="bg-blue-700 text-white shadow-lg py-3">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-tooth text-3xl"></i>
                <h1 class="text-2xl font-bold">ÁREA DO PACIENTE</h1>
            </div>
            <nav>
                <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-full font-bold hover:bg-red-700 transition">Sair</button>
            </nav>
        </div>
    </header>

    <!-- Main Content for Dashboard -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar -->
            <div class="md:w-1/4">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center mb-6">
                        <img id="profileImage" src="https://randomuser.me/api/portraits/men/75.jpg" alt="User" class="w-16 h-16 rounded-full mr-4 object-cover">
                        <div>
                            <h3 class="font-bold text-gray-800" id="dashboard-username">Carregando...</h3>
                            <p class="text-sm text-gray-600" id="dashboard-email">Carregando...</p>
                        </div>
                    </div>
                    <nav>
                        <a href="#" id="navOverview" class="block py-3 px-4 bg-teal-50 text-teal-600 rounded-lg font-medium mb-2"><i class="fas fa-home mr-2"></i> Visão Geral</a>
                        <a href="#" id="navAppointments" class="block py-3 px-4 hover:bg-gray-100 rounded-lg mb-2"><i class="fas fa-calendar-alt mr-2"></i> Meus Agendamentos</a>
                        <a href="#" id="navTreatments" class="block py-3 px-4 hover:bg-gray-100 rounded-lg mb-2"><i class="fas fa-tooth mr-2"></i> Meus Tratamentos</a>
                        <a href="#" id="navDocuments" class="block py-3 px-4 hover:bg-gray-100 rounded-lg mb-2"><i class="fas fa-file-alt mr-2"></i> Documentos</a>
                        <a href="financeiro.html" id="navPayments" class="block py-3 px-4 hover:bg-gray-100 rounded-lg mb-2"><i class="fas fa-credit-card mr-2"></i> Financeiro</a>
                        <a href="#" id="navProfile" class="block py-3 px-4 hover:bg-gray-100 rounded-lg mb-2"><i class="fas fa-user mr-2"></i> Meu Perfil</a>
                        <button id="logoutSidebarBtn" class="block w-full text-left py-3 px-4 hover:bg-gray-100 rounded-lg text-red-500"><i class="fas fa-sign-out-alt mr-2"></i> Sair</button>
                    </nav>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="md:w-3/4">
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Bem-vindo de volta, <span id="dashboard-greeting">Carregando...</span>!</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Dashboard Card: Próxima Consulta -->
                        <div class="bg-teal-50 rounded-lg p-6 dashboard-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-gray-600 mb-1">Próxima Consulta</h3>
                                    <p id="nextAppointmentDate" class="text-2xl font-bold text-gray-800">N/A</p>
                                    <p id="nextAppointmentDetails" class="text-gray-600">Nenhum agendamento futuro</p>
                                </div>
                                <div class="bg-teal-100 p-3 rounded-full">
                                    <i class="fas fa-calendar-check text-teal-600 text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Card: Tratamento Atual -->
                        <div class="bg-blue-50 rounded-lg p-6 dashboard-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-gray-600 mb-1">Tratamento Atual</h3>
                                    <p id="currentTreatment" class="text-2xl font-bold text-gray-800">N/A</p>
                                    <p id="treatmentProgress" class="text-gray-600">Nenhum tratamento em andamento</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <i class="fas fa-tooth text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Card: Documentos -->
                        <div class="bg-purple-50 rounded-lg p-6 dashboard-card">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-gray-600 mb-1">Documentos</h3>
                                    <p id="documentCount" class="text-2xl font-bold text-gray-800">0</p>
                                    <p class="text-gray-600">Disponíveis</p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-full">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-4">Seus Próximos Compromissos</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-gray-700">Data</th>
                                    <th class="py-3 px-4 text-left text-gray-700">Horário</th>
                                    <th class="py-3 px-4 text-left text-gray-700">Procedimento</th>
                                    <th class="py-3 px-4 text-left text-gray-700">Dentista</th>
                                    <th class="py-3 px-4 text-left text-gray-700">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="upcomingAppointmentsTableBody">
                                <!-- Appointments will be loaded here -->
                                <tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">Nenhum compromisso futuro.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Seus Tratamentos em Andamento</h3>
                    <div class="space-y-4" id="currentTreatmentsContainer">
                        <!-- Treatments will be loaded here -->
                        <p class="text-gray-500 text-center">Nenhum tratamento em andamento.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2023 Odontologia Vigia. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Importe as funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // ATENÇÃO: Substitua os valores abaixo pela sua nova firebaseConfig
        // que você obteve do console do Firebase após recriar o app web.
        const firebaseConfig = {
            apiKey: "SUA_NOVA_API_KEY_AQUI",
            authDomain: "SEU_AUTH_DOMAIN_AQUI",
            projectId: "SEU_PROJECT_ID_AQUI",
            storageBucket: "SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
            appId: "SEU_NOVO_APP_ID_AQUI"
        };

        // Inicialize o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Instância de autenticação
        const db = getFirestore(app); // Instância do Firestore
        const usuariosRef = collection(db, 'USUARIO');
        const agendamentosRef = collection(db, 'AGENDAMENTOS');

        // URL da sua API Flask. Para deploy no Vercel, DEVE ser "/api".
        const flaskApiUrl = "/api";

        // Elementos do DOM
        const dashboardUsernameEl = document.getElementById('dashboard-username');
        const dashboardEmailEl = document.getElementById('dashboard-email');
        const dashboardGreetingEl = document.getElementById('dashboard-greeting');
        const profileImageEl = document.getElementById('profileImage');
        const nextAppointmentDateEl = document.getElementById('nextAppointmentDate');
        const nextAppointmentDetailsEl = document.getElementById('nextAppointmentDetails');
        const upcomingAppointmentsTableBody = document.getElementById('upcomingAppointmentsTableBody');
        const currentTreatmentEl = document.getElementById('currentTreatment');
        const treatmentProgressEl = document.getElementById('treatmentProgress');
        const documentCountEl = document.getElementById('documentCount');
        const currentTreatmentsContainer = document.getElementById('currentTreatmentsContainer');

        // Função para carregar dados do usuário e agendamentos
        async function loadUserData(userEmail) {
            try {
                // Carregar dados do usuário da API Flask
                const userRes = await fetch(`${flaskApiUrl}/completar_perfil`, {
                    method: "POST", // Usamos POST para enviar o email, embora GET com query params seria mais RESTful
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: userEmail })
                });
                const userData = await userRes.json();

                if (userRes.ok && userData.usuario) { // Assumindo que a API retorna 'usuario' em caso de sucesso
                    dashboardUsernameEl.textContent = userData.usuario.nome || 'Paciente';
                    dashboardEmailEl.textContent = userData.usuario.email || '';
                    dashboardGreetingEl.textContent = userData.usuario.nome ? userData.usuario.nome.split(' ')[0] : 'Paciente';
                    // Atualize a imagem de perfil se tiver uma URL no userData.usuario.fotoPerfil
                    // profileImageEl.src = userData.usuario.fotoPerfil || 'https://randomuser.me/api/portraits/men/75.jpg';
                } else {
                    console.error("Erro ao carregar dados do usuário:", userData.erro);
                    // Opcional: Redirecionar para perfil.html se o perfil não estiver completo
                    // window.location.href = "perfil.html";
                }

                // Carregar próximos agendamentos da API Flask (você precisará criar este endpoint)
                // Exemplo de como seria o endpoint: /api/agendamentos_paciente?email=userEmail
                const appointmentsRes = await fetch(`${flaskApiUrl}/agendamentos_paciente?email=${userEmail}`);
                const appointmentsData = await appointmentsRes.json();

                if (appointmentsRes.ok && appointmentsData.agendamentos) {
                    const now = new Date();
                    const upcoming = appointmentsData.agendamentos
                        .filter(app => new Date(`${app.data_consulta}T${app.hora_consulta}`) >= now)
                        .sort((a, b) => new Date(`${a.data_consulta}T${a.hora_consulta}`) - new Date(`${b.data_consulta}T${b.hora_consulta}`));

                    upcomingAppointmentsTableBody.innerHTML = ''; // Limpa a tabela

                    if (upcoming.length > 0) {
                        const nextApp = upcoming[0];
                        nextAppointmentDateEl.textContent = nextApp.data_consulta;
                        nextAppointmentDetailsEl.textContent = `${nextApp.hora_consulta} - ${nextApp.procedimento}`;

                        upcoming.forEach(app => {
                            const row = document.createElement('tr');
                            row.className = 'border-b border-gray-200 hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="py-3 px-4">${app.data_consulta}</td>
                                <td class="py-3 px-4">${app.hora_consulta}</td>
                                <td class="py-3 px-4">${app.procedimento}</td>
                                <td class="py-3 px-4">${app.dentista}</td>
                                <td class="py-3 px-4">
                                    <button class="text-teal-600 hover:text-teal-800 mr-3"><i class="fas fa-eye"></i></button>
                                    <button class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                                    <button class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            `;
                            upcomingAppointmentsTableBody.appendChild(row);
                        });
                    } else {
                        nextAppointmentDateEl.textContent = "N/A";
                        nextAppointmentDetailsEl.textContent = "Nenhum agendamento futuro";
                        upcomingAppointmentsTableBody.innerHTML = '<tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">Nenhum compromisso futuro.</td></tr>';
                    }
                } else {
                    console.error("Erro ao carregar agendamentos:", appointmentsData.erro);
                    nextAppointmentDateEl.textContent = "N/A";
                    nextAppointmentDetailsEl.textContent = "Nenhum agendamento futuro";
                    upcomingAppointmentsTableBody.innerHTML = '<tr><td colspan="5" class="py-3 px-4 text-center text-gray-500">Nenhum compromisso futuro.</td></tr>';
                }

                // Placeholder para carregar tratamentos em andamento e documentos
                currentTreatmentsContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum tratamento em andamento (funcionalidade a ser implementada).</p>';
                documentCountEl.textContent = '0'; // Placeholder
            } catch (error) {
                console.error("Erro geral ao carregar dados do dashboard:", error);
                // Redirecionar para login se houver erro grave (ex: usuário não autenticado)
                // window.location.href = "login.html";
            }
        }

        // Função de Logout
        async function handleLogout() {
            try {
                await signOut(auth); // Desloga do Firebase Authentication
                localStorage.removeItem('usuario'); // Limpa dados do usuário do localStorage
                window.location.href = "login.html"; // Redireciona para a página de login
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Não foi possível fazer logout. Tente novamente.");
            }
        }

        // Event Listeners para Logout
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('logoutSidebarBtn').addEventListener('click', handleLogout);

        // Verifica o estado de autenticação ao carregar a página
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário logado via Firebase Auth (Google Login)
                loadUserData(user.email);
            } else {
                // Se não logado via Firebase Auth, tenta carregar do localStorage (Email/Senha)
                const storedUser = localStorage.getItem('usuario');
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    loadUserData(user.email);
                } else {
                    // Nenhum usuário logado, redireciona para a página de login
                    window.location.href = "login.html";
                }
            }
        });

        // Event listeners para navegação na sidebar (apenas para exemplo, não carregam conteúdo dinâmico ainda)
        document.getElementById('navOverview').addEventListener('click', (e) => { e.preventDefault(); alert('Visão Geral - Já nesta página!'); });
        document.getElementById('navAppointments').addEventListener('click', (e) => { e.preventDefault(); alert('Meus Agendamentos - Funcionalidade a ser implementada ou redirecionar para agendamentos.html'); });
        document.getElementById('navTreatments').addEventListener('click', (e) => { e.preventDefault(); alert('Meus Tratamentos - Funcionalidade a ser implementada'); });
        document.getElementById('navDocuments').addEventListener('click', (e) => { e.preventDefault(); alert('Documentos - Funcionalidade a ser implementada'); });
        document.getElementById('navPayments').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'financeiro.html'; }); // Redireciona para financeiro.html
        document.getElementById('navProfile').addEventListener('click', (e) => { e.preventDefault(); alert('Meu Perfil - Funcionalidade a ser implementada ou redirecionar para perfil.html'); });

    </script>
</body>
</html>
